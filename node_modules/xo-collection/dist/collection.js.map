{"version":3,"sources":["../src/collection.js"],"names":["createObject","Object","create","keys","hasOwnProperty","prototype","ACTION_ADD","ACTION_UPDATE","ACTION_REMOVE","BufferAlreadyFlushed","BaseError","constructor","DuplicateIndex","name","DuplicateItem","key","IllegalTouch","value","InvalidKey","NoSuchIndex","NoSuchItem","assertValidKey","isValidKey","Collection","EventEmitter","_buffer","_buffering","_indexes","_indexedItems","_items","_size","getKey","id","all","indexes","size","add","keyOrObjectWithId","valueIfKey","undefined","_resolveItem","_assertHasNot","_touch","clear","forEach","_remove","remove","_assertHas","set","action","has","touch","get","unset","update","defaultValue","arguments","length","call","createIndex","index","items","_attachCollection","deleteIndex","_detachCollection","Symbol","iterator","values","bufferEvents","called","buffer","data","emit","flush","process","nextTick"],"mappings":"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","sourcesContent":["import kindOf from 'kindof'\nimport { BaseError } from 'make-error'\nimport { EventEmitter } from 'events'\nimport { forOwn } from 'lodash'\n\nimport isEmpty from './is-empty'\nimport isObject from './is-object'\n\n// ===================================================================\n\nconst {\n  create: createObject,\n  keys,\n  prototype: { hasOwnProperty },\n} = Object\n\nexport const ACTION_ADD = 'add'\nexport const ACTION_UPDATE = 'update'\nexport const ACTION_REMOVE = 'remove'\n\n// ===================================================================\n\nexport class BufferAlreadyFlushed extends BaseError {\n  constructor() {\n    super('buffer flush already requested')\n  }\n}\n\nexport class DuplicateIndex extends BaseError {\n  constructor(name) {\n    super('there is already an index with the name ' + name)\n  }\n}\n\nexport class DuplicateItem extends BaseError {\n  constructor(key) {\n    super('there is already a item with the key ' + key)\n  }\n}\n\nexport class IllegalTouch extends BaseError {\n  constructor(value) {\n    super('only an object value can be touched (found a ' + kindOf(value) + ')')\n  }\n}\n\nexport class InvalidKey extends BaseError {\n  constructor(key) {\n    super('invalid key of type ' + kindOf(key))\n  }\n}\n\nexport class NoSuchIndex extends BaseError {\n  constructor(name) {\n    super('there is no index with the name ' + name)\n  }\n}\n\nexport class NoSuchItem extends BaseError {\n  constructor(key) {\n    super('there is no item with the key ' + key)\n  }\n}\n\n// -------------------------------------------------------------------\n\nconst assertValidKey = key => {\n  if (!isValidKey(key)) {\n    throw new InvalidKey(key)\n  }\n}\n\nconst isValidKey = key => typeof key === 'number' || typeof key === 'string'\n\n// -------------------------------------------------------------------\n\nexport class Collection extends EventEmitter {\n  constructor() {\n    super()\n\n    this._buffer = createObject(null)\n    this._buffering = 0\n    this._indexes = createObject(null)\n    this._indexedItems = createObject(null)\n    this._items = createObject(null)\n    this._size = 0\n  }\n\n  // Overridable method used to compute the key of an item when\n  // unspecified.\n  //\n  // Default implementation returns the `id` property.\n  getKey(value) {\n    return value && value.id\n  }\n\n  // -----------------------------------------------------------------\n  // Properties\n  // -----------------------------------------------------------------\n\n  get all() {\n    return this._items\n  }\n\n  get indexes() {\n    return this._indexedItems\n  }\n\n  get size() {\n    return this._size\n  }\n\n  // -----------------------------------------------------------------\n  // Manipulation\n  // -----------------------------------------------------------------\n\n  add(keyOrObjectWithId, valueIfKey = undefined) {\n    const [key, value] = this._resolveItem(keyOrObjectWithId, valueIfKey)\n    this._assertHasNot(key)\n\n    this._items[key] = value\n    this._size++\n    this._touch(ACTION_ADD, key)\n  }\n\n  clear() {\n    keys(this._items).forEach(this._remove, this)\n  }\n\n  remove(keyOrObjectWithId) {\n    const [key] = this._resolveItem(keyOrObjectWithId)\n    this._assertHas(key)\n\n    this._remove(key)\n  }\n\n  set(keyOrObjectWithId, valueIfKey = undefined) {\n    const [key, value] = this._resolveItem(keyOrObjectWithId, valueIfKey)\n\n    const action = this.has(key) ? ACTION_UPDATE : ACTION_ADD\n    this._items[key] = value\n    if (action === ACTION_ADD) {\n      this._size++\n    }\n    this._touch(action, key)\n  }\n\n  touch(keyOrObjectWithId) {\n    const [key] = this._resolveItem(keyOrObjectWithId)\n    this._assertHas(key)\n    const value = this.get(key)\n    if (!isObject(value)) {\n      throw new IllegalTouch(value)\n    }\n\n    this._touch(ACTION_UPDATE, key)\n\n    return this.get(key)\n  }\n\n  unset(keyOrObjectWithId) {\n    const [key] = this._resolveItem(keyOrObjectWithId)\n\n    if (this.has(key)) {\n      this._remove(key)\n    }\n  }\n\n  update(keyOrObjectWithId, valueIfKey = undefined) {\n    const [key, value] = this._resolveItem(keyOrObjectWithId, valueIfKey)\n    this._assertHas(key)\n\n    this._items[key] = value\n    this._touch(ACTION_UPDATE, key)\n  }\n\n  // -----------------------------------------------------------------\n  // Query\n  // -----------------------------------------------------------------\n\n  get(key, defaultValue) {\n    if (this.has(key)) {\n      return this._items[key]\n    }\n\n    if (arguments.length > 1) {\n      return defaultValue\n    }\n\n    throw new NoSuchItem(key)\n  }\n\n  has(key) {\n    return hasOwnProperty.call(this._items, key)\n  }\n\n  // -----------------------------------------------------------------\n  // Indexes\n  // -----------------------------------------------------------------\n\n  createIndex(name, index) {\n    const indexes = this._indexes\n    if (hasOwnProperty.call(indexes, name)) {\n      throw new DuplicateIndex(name)\n    }\n\n    indexes[name] = index\n    this._indexedItems[name] = index.items\n\n    index._attachCollection(this)\n  }\n\n  deleteIndex(name) {\n    const indexes = this._indexes\n    if (!hasOwnProperty.call(indexes, name)) {\n      throw new NoSuchIndex(name)\n    }\n\n    const index = indexes[name]\n    delete indexes[name]\n    delete this._indexedItems[name]\n\n    index._detachCollection(this)\n  }\n\n  // -----------------------------------------------------------------\n  // Iteration\n  // -----------------------------------------------------------------\n\n  *[Symbol.iterator]() {\n    const items = this._items\n\n    for (const key in items) {\n      yield [key, items[key]]\n    }\n  }\n\n  *keys() {\n    const items = this._items\n\n    for (const key in items) {\n      yield key\n    }\n  }\n\n  *values() {\n    const items = this._items\n\n    for (const key in items) {\n      yield items[key]\n    }\n  }\n\n  // -----------------------------------------------------------------\n  // Events buffering\n  // -----------------------------------------------------------------\n\n  bufferEvents() {\n    ++this._buffering\n\n    let called = false\n    return () => {\n      if (called) {\n        throw new BufferAlreadyFlushed()\n      }\n      called = true\n\n      if (--this._buffering !== 0) {\n        return\n      }\n\n      const buffer = this._buffer\n\n      // Due to deduplication there could be nothing in the buffer.\n      if (isEmpty(buffer)) {\n        return\n      }\n\n      const data = {\n        add: createObject(null),\n        remove: createObject(null),\n        update: createObject(null),\n      }\n\n      for (const key in this._buffer) {\n        data[buffer[key]][key] = this._items[key]\n      }\n\n      forOwn(data, (items, action) => {\n        if (!isEmpty(items)) {\n          this.emit(action, items)\n        }\n      })\n\n      // Indicates the end of the update.\n      //\n      // This name has been chosen because it is used in Node writable\n      // streams when the data has been successfully committed.\n      this.emit('finish')\n\n      this._buffer = createObject(null)\n    }\n  }\n\n  // =================================================================\n\n  _assertHas(key) {\n    if (!this.has(key)) {\n      throw new NoSuchItem(key)\n    }\n  }\n\n  _assertHasNot(key) {\n    if (this.has(key)) {\n      throw new DuplicateItem(key)\n    }\n  }\n\n  _remove(key) {\n    delete this._items[key]\n    this._size--\n    this._touch(ACTION_REMOVE, key)\n  }\n\n  _resolveItem(keyOrObjectWithId, valueIfKey = undefined) {\n    if (valueIfKey !== undefined) {\n      assertValidKey(keyOrObjectWithId)\n\n      return [keyOrObjectWithId, valueIfKey]\n    }\n\n    if (isValidKey(keyOrObjectWithId)) {\n      return [keyOrObjectWithId]\n    }\n\n    const key = this.getKey(keyOrObjectWithId)\n    assertValidKey(key)\n\n    return [key, keyOrObjectWithId]\n  }\n\n  _touch(action, key) {\n    if (this._buffering === 0) {\n      const flush = this.bufferEvents()\n\n      process.nextTick(flush)\n    }\n\n    if (action === ACTION_ADD) {\n      this._buffer[key] = key in this._buffer ? ACTION_UPDATE : ACTION_ADD\n    } else if (action === ACTION_REMOVE) {\n      if (this._buffer[key] === ACTION_ADD) {\n        delete this._buffer[key]\n      } else {\n        this._buffer[key] = ACTION_REMOVE\n      }\n    } else {\n      // update\n      if (!(key in this._buffer)) {\n        this._buffer[key] = ACTION_UPDATE\n      }\n    }\n  }\n}\n"],"file":"collection.js"}